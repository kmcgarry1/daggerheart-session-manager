rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() {
      return request.auth != null;
    }

    function sessionDoc(sessionId) {
      return get(/databases/$(database)/documents/sessions/$(sessionId));
    }

    function sessionExists(sessionId) {
      return exists(/databases/$(database)/documents/sessions/$(sessionId));
    }

    function sessionActive(sessionId) {
      return sessionExists(sessionId) &&
        sessionDoc(sessionId).data.sessionExpiresAt > request.time;
    }

    function isSessionHost(sessionId) {
      return isAuthed() &&
        sessionExists(sessionId) &&
        sessionDoc(sessionId).data.host.uid == request.auth.uid;
    }

    function isSessionMember(sessionId) {
      return isAuthed() && (
        exists(/databases/$(database)/documents/sessions/$(sessionId)/members/$(request.auth.uid)) ||
        (request.auth.token.firebase.sign_in_provider == "anonymous" &&
          exists(/databases/$(database)/documents/sessions/$(sessionId)/members/$("guest-" + request.auth.uid)))
      );
    }

    function hasSavedSession(sessionId) {
      return isAuthed() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)/sessions/$(sessionId));
    }

    function canJoinSession(sessionId) {
      return sessionDoc(sessionId).data.codeExpiresAt > request.time ||
        isSessionHost(sessionId) ||
        hasSavedSession(sessionId);
    }

    function isTimestamp(value) {
      return value is timestamp || value == request.time;
    }

    function validSession(data) {
      return data.code is string &&
        data.code.size() == 6 &&
        (data.name == null || data.name is string) &&
        data.host is map &&
        data.host.name is string &&
        data.host.memberId is string &&
        (data.host.uid == null || data.host.uid is string) &&
        data.host.isGuest is bool &&
        data.fear is int &&
        data.fear >= 0 &&
        data.fear <= 12 &&
        data.codeExpiresAt is timestamp &&
        data.codeExpiresAt > request.time &&
        data.sessionExpiresAt is timestamp &&
        data.sessionExpiresAt > request.time;
    }

    function validMember(data) {
      return data.name is string &&
        data.name.size() > 0 &&
        data.isGuest is bool &&
        (data.uid == null || data.uid is string) &&
        data.role in ["host", "player"];
    }

    function validCountdown(data) {
      return data.name is string &&
        data.name.size() > 0 &&
        data.max is int &&
        data.max >= 1 &&
        data.value is int &&
        data.value >= 0 &&
        data.value <= data.max;
    }

    function validInvite(data) {
      return data.toUid is string &&
        data.fromUid is string &&
        data.fromName is string &&
        data.sessionId is string &&
        (data.sessionName == null || data.sessionName is string) &&
        data.sessionCode is string &&
        (data.sessionExpiresAt == null || data.sessionExpiresAt is timestamp) &&
        (data.message == null || data.message is string) &&
        data.status in ["pending", "accepted", "declined", "revoked"] &&
        isTimestamp(data.createdAt) &&
        isTimestamp(data.updatedAt);
    }

    function validFriendship(data) {
      return data.users is list &&
        data.users.size() == 2 &&
        data.users[0] is string &&
        data.users[1] is string &&
        data.requesterUid is string &&
        data.requesterName is string &&
        (data.requesterPhotoURL == null || data.requesterPhotoURL is string) &&
        data.addresseeUid is string &&
        data.addresseeName is string &&
        (data.addresseePhotoURL == null || data.addresseePhotoURL is string) &&
        data.status in ["pending", "accepted", "declined", "cancelled"] &&
        isTimestamp(data.createdAt) &&
        isTimestamp(data.updatedAt);
    }

    match /sessionCodes/{code} {
      allow get: if isAuthed();
      allow list: if false;
      allow create: if isAuthed() &&
        code.size() == 6 &&
        request.resource.data.sessionId is string &&
        request.resource.data.codeExpiresAt is timestamp &&
        request.resource.data.sessionExpiresAt is timestamp &&
        request.resource.data.codeExpiresAt > request.time &&
        request.resource.data.sessionExpiresAt > request.time &&
        sessionDoc(request.resource.data.sessionId).data.code == code &&
        sessionDoc(request.resource.data.sessionId).data.codeExpiresAt ==
          request.resource.data.codeExpiresAt &&
        sessionDoc(request.resource.data.sessionId).data.sessionExpiresAt ==
          request.resource.data.sessionExpiresAt &&
        isSessionHost(request.resource.data.sessionId);
      allow update, delete: if false;
    }

    match /sessions/{sessionId} {
      allow get: if isAuthed() &&
        sessionActive(sessionId) &&
        (resource.data.codeExpiresAt > request.time ||
          isSessionMember(sessionId) ||
          (request.auth.token.firebase.sign_in_provider != "anonymous" && hasSavedSession(sessionId)));
      allow list: if false;
      allow create: if isAuthed() &&
        validSession(request.resource.data) &&
        request.resource.data.host.uid == request.auth.uid;
      allow update: if isSessionHost(sessionId) &&
        sessionActive(sessionId) &&
        request.resource.data.code == resource.data.code &&
        request.resource.data.name == resource.data.name &&
        request.resource.data.host == resource.data.host &&
        request.resource.data.codeExpiresAt == resource.data.codeExpiresAt &&
        request.resource.data.sessionExpiresAt == resource.data.sessionExpiresAt &&
        request.resource.data.fear is int &&
        request.resource.data.fear >= 0 &&
        request.resource.data.fear <= 12;
      allow delete: if false;
    }

    match /sessions/{sessionId}/members/{memberId} {
      allow read: if isSessionMember(sessionId);
      allow create: if sessionActive(sessionId) &&
        isAuthed() &&
        (memberId == request.auth.uid ||
          (request.auth.token.firebase.sign_in_provider == "anonymous" &&
            memberId.matches("guest-.*") &&
            request.resource.data.uid == request.auth.uid)) &&
        validMember(request.resource.data) &&
        canJoinSession(sessionId);
      allow update: if sessionActive(sessionId) &&
        isAuthed() &&
        (memberId == request.auth.uid ||
          (request.auth.token.firebase.sign_in_provider == "anonymous" &&
            resource.data.uid == request.auth.uid)) &&
        validMember(request.resource.data) &&
        request.resource.data.role == resource.data.role &&
        request.resource.data.uid == resource.data.uid;
      allow delete: if false;
    }

    match /sessions/{sessionId}/countdowns/{countdownId} {
      allow read: if isSessionMember(sessionId);
      allow create: if sessionActive(sessionId) &&
        isSessionHost(sessionId) &&
        validCountdown(request.resource.data);
      allow update: if sessionActive(sessionId) &&
        isSessionHost(sessionId) &&
        validCountdown(request.resource.data) &&
        request.resource.data.name == resource.data.name &&
        request.resource.data.max == resource.data.max;
      allow delete: if sessionActive(sessionId) && isSessionHost(sessionId);
    }

    match /users/{uid} {
      allow read, write: if isAuthed() && request.auth.uid == uid;

      match /sessions/{sessionId} {
        allow read: if isAuthed() && request.auth.uid == uid;
        allow write: if isAuthed() &&
          request.auth.uid == uid &&
          request.auth.token.firebase.sign_in_provider != "anonymous" &&
          isSessionMember(sessionId);
      }
    }

    match /publicProfiles/{uid} {
      allow read: if isAuthed();
      allow write: if isAuthed() && request.auth.uid == uid;
    }

    match /friendships/{friendshipId} {
      allow read: if isAuthed() && request.auth.uid in resource.data.users;
      allow create: if isAuthed() &&
        request.resource.data.requesterUid == request.auth.uid &&
        request.resource.data.status == "pending" &&
        request.auth.uid in request.resource.data.users &&
        validFriendship(request.resource.data);
      allow update: if isAuthed() &&
        validFriendship(request.resource.data) &&
        request.resource.data.users == resource.data.users &&
        request.resource.data.requesterUid == resource.data.requesterUid &&
        request.resource.data.requesterName == resource.data.requesterName &&
        request.resource.data.requesterPhotoURL == resource.data.requesterPhotoURL &&
        request.resource.data.addresseeUid == resource.data.addresseeUid &&
        request.resource.data.addresseeName == resource.data.addresseeName &&
        request.resource.data.addresseePhotoURL == resource.data.addresseePhotoURL &&
        request.resource.data.createdAt == resource.data.createdAt &&
        (
          (request.auth.uid == resource.data.addresseeUid &&
            request.resource.data.status in ["accepted", "declined"]) ||
          (request.auth.uid == resource.data.requesterUid &&
            request.resource.data.status == "cancelled")
        );
      allow delete: if false;
    }

    match /invites/{inviteId} {
      allow read: if isAuthed() &&
        (resource.data.toUid == request.auth.uid ||
          resource.data.fromUid == request.auth.uid);
      allow create: if isAuthed() &&
        request.resource.data.fromUid == request.auth.uid &&
        request.resource.data.status == "pending" &&
        validInvite(request.resource.data);
      allow update: if isAuthed() &&
        validInvite(request.resource.data) &&
        request.resource.data.toUid == resource.data.toUid &&
        request.resource.data.fromUid == resource.data.fromUid &&
        request.resource.data.fromName == resource.data.fromName &&
        request.resource.data.sessionId == resource.data.sessionId &&
        request.resource.data.sessionName == resource.data.sessionName &&
        request.resource.data.sessionCode == resource.data.sessionCode &&
        request.resource.data.sessionExpiresAt == resource.data.sessionExpiresAt &&
        request.resource.data.message == resource.data.message &&
        request.resource.data.createdAt == resource.data.createdAt &&
        (
          (request.auth.uid == resource.data.toUid &&
            request.resource.data.status in ["accepted", "declined"]) ||
          (request.auth.uid == resource.data.fromUid &&
            request.resource.data.status == "revoked")
        );
      allow delete: if false;
    }
  }
}
